!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).Buried=e()}(this,(function(){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */function t(t,e){var r,o,n,i,a={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,o&&(n=2&i[0]?o.return:i[0]?o.throw||((n=o.return)&&n.call(o),0):o.next)&&!(n=n.call(o,i[1])).done)return n;switch(o=0,n&&(i=[2&i[0],n.value]),i[0]){case 0:case 1:n=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(n=(n=a.trys).length>0&&n[n.length-1])&&(6===i[0]||2===i[0])){a=0;continue}if(3===i[0]&&(!n||i[1]>n[0]&&i[1]<n[3])){a.label=i[1];break}if(6===i[0]&&a.label<n[1]){a.label=n[1],n=i;break}if(n&&a.label<n[2]){a.label=n[2],a.ops.push(i);break}n[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],o=0}finally{r=n=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}function e(t){var e="function"==typeof Symbol&&t[Symbol.iterator],r=0;return e?e.call(t):{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}}}function r(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var o,n,i=r.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(o=i.next()).done;)a.push(o.value)}catch(t){n={error:t}}finally{try{o&&!o.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}return a}var o=function(){function e(t){this.data=this.getInitData(),this.options=t;var e=this.getData();e&&(this.data=e)}return e.prototype.setData=function(t){if(this.options.setData)this.options.setData(t);else{if(!window||!window.localStorage)throw new Error("[Buried] need to provide storage methods for current environment!");window.localStorage.setItem("__BURIED_DATA__",JSON.stringify(t))}},e.prototype.getData=function(){if(this.options.getData)return this.options.getData();if(!window||!window.localStorage)throw new Error("[Buried] need to provide storage methods for current environment!");var t=window.localStorage.getItem("__BURIED_DATA__");if(!t)return null;try{return JSON.parse(t)}catch(t){return null}},e.prototype.getInitData=function(){return{version:"1.0.0",data:[],lastReportTime:(new Date).getTime(),lastUpdateTime:(new Date).getTime()}},e.prototype.reset=function(){this.data=this.getInitData(),this.setData(this.data)},e.prototype.put=function(t){var e;t&&(this.data.data||(this.data.data=[]),Array.isArray(t)?(e=this.data.data).push.apply(e,function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(r(arguments[e]));return t}(t)):this.data.data.push(t),this.data.lastUpdateTime=(new Date).getTime(),this.setData(this.data))},e.prototype.report=function(){return e=this,r=void 0,n=function(){var e,r;return t(this,(function(t){switch(t.label){case 0:return this.options.report?[4,this.options.report(this.options.url,this.data.data)]:[3,2];case 1:return e=t.sent(),this.reset(),[2,e];case 2:if(window&&window.fetch)return r={method:"POST"},[2,fetch(this.options.url,r).then((function(t){return console.log(t),t.json()}))];throw new Error("[Buried] need to provide a http request adepter for current environment!")}}))},new((o=void 0)||(o=Promise))((function(t,i){function a(t){try{u(n.next(t))}catch(t){i(t)}}function s(t){try{u(n.throw(t))}catch(t){i(t)}}function u(e){e.done?t(e.value):new o((function(t){t(e.value)})).then(a,s)}u((n=n.apply(e,r||[])).next())}));var e,r,o,n},e}(),n=function(){function t(t){this.period=12e4,this.subscribers=[],this.setPeriod(t),this.start()}return t.prototype.emit=function(){var t,r;try{for(var o=e(this.subscribers),n=o.next();!n.done;n=o.next()){var i=n.value;i&&"function"==typeof i&&i()}}catch(e){t={error:e}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}},t.prototype.start=function(){var t=this;this.timer&&clearInterval(this.timer),this.timer=setInterval((function(){t.emit()}),this.period)},t.prototype.stop=function(){clearInterval(this.timer)},t.prototype.on=function(t){this.subscribers.push(t)},t.prototype.setPeriod=function(t){t&&(this.period=t)},t.prototype.getPeriod=function(){return this.period},t}();return function(){function t(t){var r=this;this.listeners=[],this.options=t,this.store=new o({url:t.url,getData:t.getData,setData:t.setData,report:t.report}),this.timer=new n(t.period),this.timer.on((function(){var t,o,n=r.store.data;try{for(var i=e(r.listeners),a=i.next();!a.done;a=i.next()){var s=a.value;s&&"function"==typeof s&&s(n.data)}}catch(e){t={error:e}}finally{try{a&&!a.done&&(o=i.return)&&o.call(i)}finally{if(t)throw t.error}}r.report()}))}return t.prototype.put=function(t){this.store.put(t)},t.prototype.report=function(){return this.store.report()},t.prototype.reset=function(){this.store.reset()},t.prototype.stop=function(){this.timer.stop()},t.prototype.start=function(){this.timer.start()},t.prototype.setPeriod=function(t){this.timer.stop(),this.options.period=t,this.timer.setPeriod(t),this.timer.start()},t.prototype.onReport=function(t){this.listeners.push(t)},t}()}));
